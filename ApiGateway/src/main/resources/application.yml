server:
  port: 9090

spring:
  application:
    name: api-gateway
  config:
    import: 'optional:configserver:'  # Disable config server requirement

  cloud:
    gateway:
      # Discovery Locator Configuration - Auto-routing based on service names
      discovery:
        locator:
          enabled: false
          lower-case-service-id: true

      # Route Definitions
      routes:
        # Accounts Microservice Routes
        - id: accounts-service
          uri: lb://accounts-service
          predicates:
            - Path=/api/v1/accounts/**
            - Method=GET,POST,PUT,DELETE
          filters:
            - name: CircuitBreaker
              args:
                name: accountsService
                fallbackUri: forward:/fallback/accounts
            - name: Retry
              args:
                retries: 3
                statuses: BAD_GATEWAY,SERVICE_UNAVAILABLE
                methods: GET,POST
                backoff:
                  firstBackoff: 10ms
                  maxBackoff: 50ms
                  factor: 2
                basedOnPreviousValue: false

        # Eureka Dashboard Route
        - id: eureka-server
          uri: lb://eureka-server
          predicates:
            - Path=/eureka/**

        # Health Check Routes
        - id: health-check
          uri: lb://accounts-service
          predicates:
            - Path=/actuator/health/**

      # Global CORS Configuration
      globalcors:
        cors-configurations:
          '[/**]':
            allowed-origins: "*"
            allowed-methods:
              - GET
              - POST
              - PUT
              - DELETE
              - OPTIONS
            allowed-headers: "*"
            max-age: 3600

      # Default Filters
      default-filters:
        - name: Retry
          args:
            retries: 3
            statuses: BAD_GATEWAY,SERVICE_UNAVAILABLE

    # Circuit Breaker Configuration
    resilience4j:
      circuitbreaker:
        configs:
          default:
            sliding-window-size: 10
            minimum-number-of-calls: 5
            failure-rate-threshold: 50
            wait-duration-in-open-state: 10s
            permitted-number-of-calls-in-half-open-state: 3
        instances:
          accountsService:
            base-config: default

    # Distributed Tracing with Zipkin
    compatibility-verifier:
      enabled: false

# Eureka Client Configuration
eureka:
  client:
    enabled: true
    register-with-eureka: false  # Gateway doesn't need to register, only discover services
    fetch-registry: true
    service-url:
      defaultZone: ${EUREKA_SERVER_URL:http://localhost:8761/eureka/}
    registry-fetch-interval-seconds: 30

# Management & Actuator
management:
  endpoints:
    web:
      exposure:
        include: '*'
  endpoint:
    health:
      show-details: always
      probes:
        enabled: true
    gateway:
      enabled: true
  health:
    readinessstate:
      enabled: true
    livenessstate:
      enabled: true
  metrics:
    export:
      prometheus:
        enabled: true

# Logging
logging:
  level:
    root: INFO
    com.medo.gateway: DEBUG
    org.springframework.cloud.gateway: DEBUG
    org.springframework.web.reactive.function.client: DEBUG

# Rate Limiter Configuration (using in-memory for demo, use Redis for production)
app:
  ratelimit:
    enabled: true
    # For production, configure Redis:
    # spring.redis.host: localhost
    # spring.redis.port: 6379
